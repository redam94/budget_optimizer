# Optimizer
Matthew Reda

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

------------------------------------------------------------------------

<a
href="https://github.com/redam94/budget_optimizer/blob/main/budget_optimizer/optimizer.py#L27"
target="_blank" style="float:right; font-size:smaller">source</a>

### BaseOptimizer

>  BaseOptimizer
>                     (model:budget_optimizer.utils.model_classes.BaseBudgetMode
>                     l, config_path:str|pathlib.Path)

*Optimizer wrapper for the pyswarms package*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>model</td>
<td>BaseBudgetModel</td>
<td>The model to optimize</td>
</tr>
<tr>
<td>config_path</td>
<td>str | pathlib.Path</td>
<td>Path to the configuration files</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/redam94/budget_optimizer/blob/main/budget_optimizer/optimizer.py#L84"
target="_blank" style="float:right; font-size:smaller">source</a>

### ScipyBudgetOptimizer

>  ScipyBudgetOptimizer
>                            (model:budget_optimizer.utils.model_classes.BaseBud
>                            getModel, config_path:str|pathlib.Path)

*Optimizer wrapper for the pyswarms package*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>model</td>
<td>BaseBudgetModel</td>
<td>The model to optimize</td>
</tr>
<tr>
<td>config_path</td>
<td>str | pathlib.Path</td>
<td>Path to the configuration files</td>
</tr>
</tbody>
</table>

``` python
class BudgetModel(BaseBudgetModel):
    """
    Budget model class
    """
    ...
```

``` python
fast_model = BudgetModel("Revenue Model", "Revenue", "../example_files/fast_model")
```

``` python
init_budget = np.array([2, 3])
bounds = [(3, 5), (3, 5)]
constraints = opt.LinearConstraint([[1, 1]], [8], [8])
o = ScipyBudgetOptimizer(fast_model, "../example_files")
```

------------------------------------------------------------------------

<a
href="https://github.com/redam94/budget_optimizer/blob/main/budget_optimizer/optimizer.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### ScipyBudgetOptimizer.optimize

>  ScipyBudgetOptimizer.optimize (bounds:list[tuple[float,float]],
>                                     constraints:None|scipy.optimize._constrain
>                                     ts.LinearConstraint,
>                                     init_pos:numpy.ndarray)

*Optimize the model*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>bounds</td>
<td>list</td>
<td>Bounds for the optimizer</td>
</tr>
<tr>
<td>constraints</td>
<td>None | scipy.optimize._constraints.LinearConstraint</td>
<td>Constraints for the optimizer</td>
</tr>
<tr>
<td>init_pos</td>
<td>ndarray</td>
<td>Initial position of the optimizer</td>
</tr>
</tbody>
</table>

``` python
o_fitted = o.optimize(bounds, constraints, init_pos=init_budget)
```

               message: `gtol` termination condition is satisfied.
               success: True
                status: 1
                   fun: -601.6849021505009
                     x: [ 3.168e+00  4.832e+00]
                   nit: 15
                  nfev: 30
                  njev: 10
                  nhev: 0
              cg_niter: 9
          cg_stop_cond: 1
                  grad: [-1.485e+01 -1.485e+01]
       lagrangian_grad: [-9.561e-09  9.561e-09]
                constr: [array([ 8.000e+00]), array([ 3.168e+00,  4.832e+00])]
                   jac: [array([[ 1.000e+00,  1.000e+00]]), array([[ 1.000e+00,  0.000e+00],
                               [ 0.000e+00,  1.000e+00]])]
           constr_nfev: [0, 0]
           constr_njev: [0, 0]
           constr_nhev: [0, 0]
                     v: [array([ 1.485e+01]), array([-1.731e-04,  1.731e-04])]
                method: tr_interior_point
            optimality: 9.56122952780968e-09
      constr_violation: 0.0
        execution_time: 0.0405728816986084
             tr_radius: 29797.67905015749
        constr_penalty: 1.0
     barrier_parameter: 3.200000000000001e-05
     barrier_tolerance: 3.200000000000001e-05
                 niter: 15

    Optimal budget:
    {'a': 3.17, 'b': 4.83}

------------------------------------------------------------------------

<a
href="https://github.com/redam94/budget_optimizer/blob/main/budget_optimizer/optimizer.py#L114"
target="_blank" style="float:right; font-size:smaller">source</a>

### OptunaBudgetOptimizer

>  OptunaBudgetOptimizer
>                             (model:budget_optimizer.utils.model_classes.BaseBu
>                             dgetModel, config_path:str|pathlib.Path,
>                             objective_name:str='loss',
>                             storage:str='sqlite:///db.sqlite3', direction:Lite
>                             ral['maximize','minimize']='maximize',
>                             sampler:optuna.samplers._base.BaseSampler=<class
>                             'optuna.samplers._tpe.sampler.TPESampler'>,
>                             pruner:optuna.pruners._base.BasePruner|None=None,
>                             tol:float=0.001, percent_out_tolerance:float=0.1,
>                             sampler_kwargs:dict|None=None,
>                             pruner_kwargs:dict|None=None)

*Optimizer wrapper for the pyswarms package*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>model</td>
<td>BaseBudgetModel</td>
<td></td>
<td>The model to optimize</td>
</tr>
<tr>
<td>config_path</td>
<td>str | pathlib.Path</td>
<td></td>
<td>Path to the configuration files</td>
</tr>
<tr>
<td>objective_name</td>
<td>str</td>
<td>loss</td>
<td>Name of the objective</td>
</tr>
<tr>
<td>storage</td>
<td>str</td>
<td>sqlite:///db.sqlite3</td>
<td>Storage for the optimization defaults to local sqlite</td>
</tr>
<tr>
<td>direction</td>
<td>Literal</td>
<td>maximize</td>
<td>Direction of the optimization</td>
</tr>
<tr>
<td>sampler</td>
<td>BaseSampler</td>
<td>TPESampler</td>
<td>Sampler for the optimization</td>
</tr>
<tr>
<td>pruner</td>
<td>optuna.pruners._base.BasePruner | None</td>
<td>None</td>
<td>Pruner for the optimization</td>
</tr>
<tr>
<td>tol</td>
<td>float</td>
<td>0.001</td>
<td>Tolerance for the constraints</td>
</tr>
<tr>
<td>percent_out_tolerance</td>
<td>float</td>
<td>0.1</td>
<td>Percentage of the budget trials that can be outside the
constraints</td>
</tr>
<tr>
<td>sampler_kwargs</td>
<td>dict | None</td>
<td>None</td>
<td>Additional arguments for the sampler</td>
</tr>
<tr>
<td>pruner_kwargs</td>
<td>dict | None</td>
<td>None</td>
<td>Additional arguments for the pruner</td>
</tr>
</tbody>
</table>

``` python
#load_dotenv()
#USER = os.environ.get("POSTGRES_USER", "")
#PASSWORD = os.environ.get("POSTGRES_PASSWORD", "")
#POSTGRES_URL = f"postgresql://{USER}:{PASSWORD}@localhost:54320"
POSTGRES_URL = "sqlite:///db.sqlite3"
```

``` python
#conn = await asyncpg.connect(POSTGRES_URL)
#database = "budget_optimizer"
#try:
#    db_exists = await conn.fetchval(
#                'SELECT 1 FROM pg_database WHERE datname = $1', database
#                )
#    print(db_exists)
#    if not db_exists:
#        await conn.execute(f'CREATE DATABASE {database}')
#except Exception as e:
#    print(e)
#conn.close()
#POSTGRES_URL = f"{POSTGRES_URL}/{database}"
```

``` python
optuna.logging.set_verbosity(optuna.logging.WARNING)
optuna.logging.get_logger("optuna").addHandler(logging.StreamHandler(sys.stdout))
slow_model = BudgetModel("Revenue Model", "Revenue", "../example_files/slow_model")
opt_optimizer = OptunaBudgetOptimizer(
  slow_model, "../example_files",
  storage=(POSTGRES_URL),
  direction="maximize", tol=1e-3, percent_out_tolerance=0.1,
  sampler_kwargs={"multivariate": True, "group": True})
```

------------------------------------------------------------------------

<a
href="https://github.com/redam94/budget_optimizer/blob/main/budget_optimizer/optimizer.py#L158"
target="_blank" style="float:right; font-size:smaller">source</a>

### OptunaBudgetOptimizer.optimize

>  OptunaBudgetOptimizer.optimize (bounds:dict[str,tuple[float,float]],
>                                      constraints:None|tuple=None,
>                                      timeout:int=60, n_trials:int=100,
>                                      study_name:str='optimizer',
>                                      load_if_exists:bool=False, n_jobs:int=1)

*Optimize the model*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>bounds</td>
<td>dict</td>
<td></td>
<td>Bounds for the optimizer</td>
</tr>
<tr>
<td>constraints</td>
<td>None | tuple</td>
<td>None</td>
<td>Constraints for the optimizer</td>
</tr>
<tr>
<td>timeout</td>
<td>int</td>
<td>60</td>
<td>Timeout for the optimization</td>
</tr>
<tr>
<td>n_trials</td>
<td>int</td>
<td>100</td>
<td>Max number of trials to run</td>
</tr>
<tr>
<td>study_name</td>
<td>str</td>
<td>optimizer</td>
<td>Name of the study</td>
</tr>
<tr>
<td>load_if_exists</td>
<td>bool</td>
<td>False</td>
<td>Load the study if it exists</td>
</tr>
<tr>
<td>n_jobs</td>
<td>int</td>
<td>1</td>
<td>Number of jobs to run in parallel</td>
</tr>
</tbody>
</table>

``` python
bounds = {"a": (3, 8), "b": (3, 5)}
constraints = (8, 8)
now = datetime.now()
opt_optimizer.optimize(
  bounds, constraints, 
  n_trials=200_000, timeout=30,  
  study_name=f"Optimization_{now.strftime('%Y%m%d_%H%M%S')}",
  n_jobs=4)
```

``` python
o_fitted.optimal_budget
```

    {'a': 3.1675802082673, 'b': 4.8324197917327005}

    Scipy Optimal Total Budget 8.0

``` python
opt_optimizer.optimal_budget
```

    {'b': 4.831325789181123, 'a': 3.1686742108188772}

    Optuna Optimal Total Budget 8.0

![](00_optimizer_files/figure-commonmark/cell-22-output-1.png)
